---
title: "DEV WTP betaseries"
author: "Dani Cosme"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: hide
    df_print: paged
    highlight: tango
    theme: united
    toc: yes
    toc_float:
      collapsed: yes
      smooth_scroll: yes
  pdf_document:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
options(scipen = 999)
```

# prep {.tabset}
## load packages
```{r}
library(tidyverse)
library(lme4)
library(lmerTest)
library(knitr)
```

## define aesthetics
```{r}
algorithm = c("#006989", "#FEC601", "#F43C13", "#00A5CF", "#00A878")
food = c("#A4C960", "#2A5C8C")
liking = c("#FF0000", "#F2AD00")
bid = c("#00A08A", "#F2AD00", "#F98400", "#FF0000")
dc_bw = plot_aes = theme_minimal() +
  theme(legend.position = "top",
        legend.text = element_text(size = 12),
        text = element_text(size = 16, family = "Futura Medium"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text = element_text(color = "black"),
        axis.line = element_line(colour = "black"),
        axis.ticks.y = element_blank())
```

## define functions
```{r}
table_model = function(model_data) {
  model_data %>%
    broom.mixed::tidy(., conf.int = TRUE) %>%
    rename("SE" = std.error,
           "t" = statistic,
           "p" = p.value) %>%
    filter(effect == "fixed") %>%
    select(-group, -effect) %>%
    mutate_at(vars(-contains("term"), -contains("value")), round, 2) %>%
    mutate(term = gsub(":", " x ", term),
           term = gsub("dot_", "", term),
           term = gsub("liking_rating", "liking", term),
           term = gsub("healthunhealthy", "health (unhealthy)", term),
           p = ifelse(p < .001, "< .001",
                      ifelse(p == 1, "1.000", gsub("0.(.*)", ".\\1", sprintf("%.3f", p)))),
           `b [95% CI]` = sprintf("%.2f [%0.2f, %.2f]", estimate, conf.low, conf.high)) %>%
    select(term, `b [95% CI]`, df, t, p) %>%
    kable()
}
```

## load and tidy task data
```{r}
task = read.csv("~/Documents/code/sanlab/DEV_scripts/fMRI/fx/multiconds/WTP/betaseries/events.csv", stringsAsFactors = FALSE) %>%
  mutate(bid = ifelse(bid == "NULL", NA, bid),
         bid = as.integer(bid),
         health = as.factor(health),
         liking = as.factor(liking)) %>%
  group_by(subjectID, wave, run) %>%
  mutate(trial = row_number()) %>%
  filter(wave %in% 1:2)
```

## check responses
Check if wrong buttons were used (i.e., not 5-8)

* DEV002 = wrong button box (i.e. 1-4) used 
* DEV007 = wrong button box (i.e. 1-4) used
* DEV011 = code normally
* DEV017 = exclude; can't tell if they're missed responses or incorrect placement of fingers
* DEV019 = exclude; can't tell if they're missed responses or incorrect placement of fingers
* DEV032 = code normally
* DEV033 = incorrect placement of fingers; recode runs 1-3
* DEV054 = exclude; technical error?
* DEV061 = code normally

> NB! NEED TO GO THROUGH NEW PARTICPANTS/WAVES

```{r}
subs = task %>%
  mutate(bid = as.character(bid)) %>%
  group_by(subjectID, run, bid) %>%
  summarize(n = n()) %>%
  spread(bid, n) %>%
  mutate(messed = ifelse(!is.na(`2`), "yes", NA),
         messed = ifelse(is.na(`5`) & !is.na(`<NA>`), "yes", messed)) %>%
  filter(messed == "yes") %>% 
  ungroup() %>% 
  select(subjectID) %>% 
  unique()

task %>%
  mutate(bid = as.character(bid)) %>%
  group_by(subjectID, run, bid) %>%
  summarize(n = n()) %>%
  spread(bid, n) %>%
  mutate(messed = ifelse(!is.na(`2`), "yes", NA),
         messed = ifelse(is.na(`5`) & !is.na(`<NA>`), "yes", messed)) %>%
  filter(subjectID %in% subs$subjectID)
```

## recode and exclude
Recoding  
* DEV033: recode runs1-3, but if liking rating < 3, leave as missing

> NB! NEED TO GO THROUGH NEW PARTICPANTS/WAVES

```{r}
data.ex = task %>%
  mutate(bid = ifelse(subjectID == "DEV033" & wave == 1 & !run == "run4", bid - 1, bid),
         bid = ifelse(subjectID == "DEV033" & wave == 1 & !run == "run4" & is.na(bid) & liking_rating > 2, 8, bid),
         bid = (bid - 5) / 2) %>%
  group_by(subjectID, wave) %>%
  arrange(subjectID, run) %>%
  mutate(trial = row_number())
```

## load mean intensity values
```{r}
file_dir = "~/Documents/code/sanlab/DEV_scripts/fMRI/betaseries/WTP/dotProducts_WTP_wave1/"
file_pattern = "DEV[0-9]{3}_meanIntensity.txt"
file_list = list.files(file_dir, pattern = file_pattern)

intensities = data.frame()

for (file in file_list) {
  temp = tryCatch(read.table(file.path(file_dir,file), fill = TRUE) %>%
                    rename("subjectID" = V1,
                           "meanIntensity" = V3) %>%
                    extract(V2, "beta", "beta_([0-9]{4}).nii") %>%
                    mutate(beta = as.integer(beta),
                           wave = 1), error = function(e) message(file))
  intensities = rbind(intensities, temp)
  rm(temp)
}

file_dir = "~/Documents/code/sanlab/DEV_scripts/fMRI/betaseries/WTP/dotProducts_WTP_wave2/"
file_list = list.files(file_dir, pattern = file_pattern)
for (file in file_list) {
  temp = tryCatch(read.table(file.path(file_dir,file), fill = TRUE) %>%
                    rename("subjectID" = V1,
                           "meanIntensity" = V3) %>%
                    extract(V2, "beta", "beta_([0-9]{4}).nii") %>%
                    mutate(beta = as.integer(beta),
                           wave = 2), error = function(e) message(file))
  intensities = rbind(intensities, temp)
  rm(temp)
}
```

## load dot products
```{r}
file_dir = "~/Documents/code/sanlab/DEV_scripts/fMRI/betaseries/WTP/dotProducts_WTP_wave1/"
file_pattern = "DEV[0-9]{3}_dotProducts.txt"
file_list = list.files(file_dir, pattern = file_pattern)

dots = data.frame()

for (file in file_list) {
  temp = tryCatch(read.table(file.path(file_dir,file), fill = TRUE) %>%
                    rename("subjectID" = V1,
                           "map" = V3,
                           "dotProduct" = V4) %>%
                    extract(V2, "beta", "beta_([0-9]{4}).nii") %>%
                    extract(map, "algorithm", "(.*)_.*.nii") %>%
                    mutate(beta = as.integer(beta),
                            wave = 1), error = function(e) message(file))
  dots = rbind(dots, temp)
  rm(temp)
}

file_dir = "~/Documents/code/sanlab/DEV_scripts/fMRI/betaseries/WTP/dotProducts_WTP_wave2/"
file_list = list.files(file_dir, pattern = file_pattern)

for (file in file_list) {
  temp = tryCatch(read.table(file.path(file_dir,file), fill = TRUE) %>%
                    rename("subjectID" = V1,
                           "map" = V3,
                           "dotProduct" = V4) %>%
                    extract(V2, "beta", "beta_([0-9]{4}).nii") %>%
                    extract(map, "algorithm", "(.*)_.*.nii") %>%
                    mutate(beta = as.integer(beta),
                            wave = 2), error = function(e) message(file))
  dots = rbind(dots, temp)
  rm(temp)
}
```

## join intensities and dots
* recode trials with extreme intensities as NA
```{r}
dots.merged = dots %>%
  left_join(., intensities, by = c("subjectID", "wave", "beta")) %>%
  group_by(subjectID, wave, algorithm) %>%
  mutate(rownum = row_number())

# plot original
dots.merged %>%
  filter(algorithm == "craving_regulation") %>%
  ggplot(aes(1, meanIntensity)) +
    geom_boxplot()

# assess extreme values and exclude when calculating SDs
dots.merged %>%
  filter(algorithm == "craving_regulation") %>%
  arrange(meanIntensity)

dots.merged %>%
  filter(algorithm == "craving_regulation") %>%
  arrange(-meanIntensity)

# recode outliers as NA
dots.merged = dots.merged %>%
  ungroup() %>%
  mutate(meanIntensity = ifelse(meanIntensity > 1 | meanIntensity < -1, NA, meanIntensity),
         median = median(meanIntensity, na.rm = TRUE),
         sd3 = 3*sd(meanIntensity, na.rm = TRUE),
         outlier = ifelse(meanIntensity > median + sd3 | meanIntensity < median - sd3, "yes", "no"),
         dotProduct = ifelse(outlier == "yes", NA, dotProduct))
  
# plot after
dots.merged %>%
  filter(algorithm == "craving_regulation") %>%
  ggplot(aes(1, meanIntensity)) +
  geom_boxplot()
```

## exclude outliers and standardize
* standardize within algorithm and contrast
```{r}
dots.ex = dots.merged %>%
  group_by(algorithm, wave, subjectID) %>%
  mutate(trial = row_number()) 
```

## merge data
Exclusions

* Didn't scan: DEV002, DEV007
* MRI motion and data quality exclusions: DEV001, DEV020, DEV032, DEV047, DEV063, DEV067, DEV078
* Button box exclusions: DEV017, DEV019, DEV054
* Run exclusions: DEV028 (run1), DEV048 (run3), DEV064 (run1), DEV069 (run1)

> NB! NEED TO GO THROUGH NEW PARTICPANTS/WAVES

```{r}
conditions = read.csv("~/Desktop/dev_conditions.csv")

data_all = left_join(dots.ex, data.ex, by = c("subjectID", "wave", "trial")) %>%
  filter(!subjectID %in% c("DEV002", "DEV007", "DEV001", "DEV020", "DEV032", "DEV047", "DEV063", "DEV067", "DEV078", "DEV017", "DEV019", "DEV054")) %>%
  filter(!(subjectID == "DEV028" & run == "run1" & wave == 1) & !(subjectID == "DEV048" & run == "run3" & wave == 1) &
         !(subjectID == "DEV064" & run == "run1" & wave == 1) & !(subjectID == "DEV069" & run == "run1" & wave == 1)) %>%
  ungroup() %>%
  ungroup() %>%
  mutate(algorithm = gsub("_signature", "", algorithm),
         wave = as.character(wave),
         liking = ifelse(liking_rating > 2, "liked",
                  ifelse(liking_rating < 3, "disliked", NA))) %>%
  filter(!is.na(health)) %>%
  left_join(., conditions) %>%
  filter(condition %in% c("Cognitive", "Control", "Behavioral")) %>%
  mutate(condition = factor(condition, levels = c("Control", "Cognitive", "Behavioral")))

data = data_all %>%
  filter(liking == "liked")
```


# descriptives {.tabset}
## number of participants
```{r}
data %>%
  select(subjectID, wave) %>%
  unique() %>%
  group_by(wave) %>%
  summarize(n = n())
```

## bids {.tabset}
### across waves
```{r}
data %>%
  group_by(health) %>%
  summarize(n = n(),
            mean = round(mean(bid, na.rm = TRUE), 2),
            sd = round(sd(bid, na.rm = TRUE), 2),
            min = min(bid, na.rm = TRUE),
            max = max(bid, na.rm = TRUE)) %>%
  kable(format = "pandoc")
```

### by wave
```{r}
data %>%
  group_by(wave, health) %>%
  summarize(n = n(),
            mean = round(mean(bid, na.rm = TRUE), 2),
            sd = round(sd(bid, na.rm = TRUE), 2),
            min = min(bid, na.rm = TRUE),
            max = max(bid, na.rm = TRUE)) %>%
  kable(format = "pandoc")
```

## session 0 liking ratings {.tabset}
```{r}
data_all %>%
  group_by(health) %>%
  summarize(n = n(),
            mean = round(mean(liking_rating, na.rm = TRUE), 2),
            sd = round(sd(liking_rating, na.rm = TRUE), 2),
            min = min(liking_rating, na.rm = TRUE),
            max = max(liking_rating, na.rm = TRUE)) %>%
  kable(format = "pandoc")
```

# correlations among signatures {.tabset}
## craving & Koban craving
```{r}
data %>%
  select(subjectID, wave, trial, algorithm, dotProduct) %>%
  spread(algorithm, dotProduct) %>%
  mutate(sub_wave = sprintf("%s_%s", subjectID, wave)) %>%
  rmcorr::rmcorr(as.factor(sub_wave), craving, nsc_koban, data = .)
```

## craving & craving regulation
```{r}
data %>%
  select(subjectID, wave, trial, algorithm, dotProduct) %>%
  spread(algorithm, dotProduct) %>%
  mutate(sub_wave = sprintf("%s_%s", subjectID, wave)) %>%
  rmcorr::rmcorr(as.factor(sub_wave), craving, craving_regulation, data = .)
```

## Koban craving & craving regulation
```{r}
data %>%
  select(subjectID, wave, trial, algorithm, dotProduct) %>%
  spread(algorithm, dotProduct) %>%
  mutate(sub_wave = sprintf("%s_%s", subjectID, wave)) %>%
  rmcorr::rmcorr(as.factor(sub_wave), nsc_koban, craving_regulation, data = .)
```

# visualize raw data {.tabset}
Only use liked foods (i.e., foods with a liking rating at session 0 of >2) for analyses other than when looking at relationships with liking specifically

## bids only {.tabset}
### across waves
```{r}
data %>% 
  filter(algorithm == "craving") %>%
  ggplot(aes(health, bid, fill = health)) +
  stat_summary(fun = mean, geom = "bar", position = position_dodge(.5)) +
  stat_summary(fun.data = mean_cl_boot, geom = "errorbar", position = position_dodge(.5), width = 0) +
  scale_fill_manual(values = food) +
  labs(y = "bid value ($)\n", x = "\nfood type") +
  dc_bw +
  theme(legend.position = "none")
```

### by wave
```{r}
data %>% 
  filter(algorithm == "craving") %>%
  ggplot(aes(health, bid, fill = wave)) +
  stat_summary(fun = mean, geom = "bar", position = position_dodge(.95)) +
  stat_summary(fun.data = mean_cl_boot, geom = "errorbar", position = position_dodge(.95), width = 0) +
  scale_fill_manual(values = algorithm) +
  labs(y = "bid value ($)\n", x = "\nfood type") +
  dc_bw
```

### by condition
```{r}
data %>% 
  filter(algorithm == "craving") %>%
  ggplot(aes(health, bid, fill = wave)) +
  stat_summary(fun = mean, geom = "bar", position = position_dodge(.95)) +
  stat_summary(fun.data = mean_cl_boot, geom = "errorbar", position = position_dodge(.95), width = 0) +
  facet_grid(~condition) +
  scale_fill_manual(values = algorithm) +
  labs(y = "bid value ($)\n", x = "\nfood type") +
  dc_bw
```

## bar plots {.tabset}
### health {.tabset}
#### across waves
```{r}
data %>% 
  ggplot(aes(health, dotProduct, fill = health)) +
  stat_summary(fun = mean, geom = "bar", position = position_dodge(.5)) +
  stat_summary(fun.data = mean_cl_boot, geom = "errorbar", position = position_dodge(.5), width = 0) +
  scale_fill_manual(values = food) +
  facet_grid(~algorithm) +
  labs(y = "signature expression\n", x = "\nfood type") +
  dc_bw +
  theme(legend.position = "none")
```

#### by wave
```{r}
data %>% 
  ggplot(aes(health, dotProduct, fill = wave)) +
  stat_summary(fun = mean, geom = "bar", position = position_dodge(.95)) +
  stat_summary(fun.data = mean_cl_boot, geom = "errorbar", position = position_dodge(.95), width = 0) +
  scale_fill_manual(values = algorithm) +
  facet_grid(~algorithm) +
  labs(y = "signature expression\n", x = "\nfood type") +
  dc_bw
```

#### by condition
```{r}
data %>% 
  ggplot(aes(health, dotProduct, fill = wave)) +
  stat_summary(fun = mean, geom = "bar", position = position_dodge(.95)) +
  stat_summary(fun.data = mean_cl_boot, geom = "errorbar", position = position_dodge(.95), width = 0) +
  scale_fill_manual(values = algorithm) +
  facet_grid(condition~algorithm) +
  labs(y = "signature expression\n", x = "\nfood type") +
  dc_bw
```

### bids {.tabset}
#### across waves
```{r}
data %>% 
  ggplot(aes(bid, dotProduct)) +
  stat_summary(fun = mean, geom = "bar", position = position_dodge(.5)) +
  stat_summary(fun.data = mean_cl_boot, geom = "errorbar", position = position_dodge(.5), width = 0) +
  facet_grid(~algorithm) +
  labs(y = "signature expression\n", x = "\nbid value ($)") +
  dc_bw
```

#### by wave
```{r}
data %>% 
  ggplot(aes(bid, dotProduct, fill = wave)) +
  stat_summary(fun = mean, geom = "bar", position = position_dodge(.5)) +
  stat_summary(fun.data = mean_cl_boot, geom = "errorbar", position = position_dodge(.5), width = 0) +
  facet_grid(~algorithm) +
  scale_fill_manual(values = algorithm) +
  labs(y = "signature expression\n", x = "\nbid value ($)") +
  dc_bw
```

#### by condition
```{r}
data %>% 
  ggplot(aes(bid, dotProduct, fill = wave)) +
  stat_summary(fun = mean, geom = "bar", position = position_dodge(.5)) +
  stat_summary(fun.data = mean_cl_boot, geom = "errorbar", position = position_dodge(.5), width = 0) +
  facet_grid(condition~algorithm) +
  scale_fill_manual(values = algorithm) +
  labs(y = "signature expression\n", x = "\nbid value ($)") +
  dc_bw
```

### bid x health {.tabset}
#### across waves
```{r}
data %>% 
  ggplot(aes(bid, dotProduct, fill = health)) +
  stat_summary(fun = mean, geom = "bar", position = position_dodge(.5)) +
  stat_summary(fun.data = mean_cl_boot, geom = "errorbar", position = position_dodge(.5), width = 0) +
  scale_fill_manual(values = food) +
  facet_grid(~algorithm) +
  labs(y = "signature expression\n", x = "\nbid value ($)") +
  dc_bw
```

#### by wave
```{r}
data %>% 
  ggplot(aes(bid, dotProduct, fill = wave)) +
  stat_summary(fun = mean, geom = "bar", position = position_dodge(.5)) +
  stat_summary(fun.data = mean_cl_boot, geom = "errorbar", position = position_dodge(.5), width = 0) +
  scale_fill_manual(values = algorithm) +
  facet_grid(health~algorithm) +
  labs(y = "signature expression\n", x = "\nbid value ($)") +
  dc_bw
```

#### by condition
```{r}
data %>% 
  ggplot(aes(bid, dotProduct, fill = wave)) +
  stat_summary(fun = mean, geom = "bar", position = position_dodge(.5)) +
  stat_summary(fun.data = mean_cl_boot, geom = "errorbar", position = position_dodge(.5), width = 0) +
  scale_fill_manual(values = algorithm) +
  facet_grid(condition~algorithm + health) +
  labs(y = "signature expression\n", x = "\nbid value ($)") +
  dc_bw
```

## scatterplots {.tabset}
### bids {.tabset}
#### across waves
```{r}
data %>% 
  ggplot(aes(dotProduct, bid, color = health, fill = health)) +
  geom_smooth(aes(group = interaction(subjectID, health)), method = "lm", se = FALSE, size = .1) +
  geom_smooth(method = "lm") +
  scale_color_manual(values = food) +
  scale_fill_manual(values = food) +
  facet_grid(~algorithm, scales = "free") +
  labs(x = "\nsignature expression", y = "bid value ($)\n") +
  dc_bw
```

#### by wave
```{r, fig.width=7, fig.height=7}
data %>% 
  ggplot(aes(dotProduct, bid, color = wave, fill = wave)) +
  geom_smooth(aes(group = interaction(subjectID, wave)), method = "lm", se = FALSE, size = .1) +
  geom_smooth(method = "lm") +
  scale_color_manual(values = algorithm) +
  scale_fill_manual(values = algorithm) +
  facet_grid(health~algorithm, scales = "free") +
  labs(x = "\nsignature expression", y = "bid value ($)\n") +
  dc_bw
```

#### by condition
```{r, fig.width=12, fig.height=7}
data %>% 
  ggplot(aes(dotProduct, bid, color = condition, fill = condition)) +
  geom_smooth(aes(group = interaction(subjectID, wave)), method = "lm", se = FALSE, size = .1) +
  geom_smooth(method = "lm") +
  scale_color_manual(values = algorithm) +
  scale_fill_manual(values = algorithm) +
  facet_grid(wave~algorithm + health, scales = "free") +
  labs(x = "\nsignature expression", y = "bid value ($)\n") +
  dc_bw
```

### liking {.tabset}
```{r, fig.width=12}
data_all %>% 
  ggplot(aes(dotProduct, liking_rating, color = health, fill = health)) +
  geom_smooth(aes(group = interaction(subjectID, health)), method = "lm", se = FALSE, size = .1) +
  geom_smooth(method = "lm") +
  scale_color_manual(values = food) +
  scale_fill_manual(values = food) +
  facet_grid(~algorithm, scales = "free") +
  labs(x = "\nsignature expression", y = "liking rating\n") +
  dc_bw +
  theme(legend.position = "top")
```

# MLM {.tabset}
Disaggregate within and between person relationships

* `dot_between` = grand mean centered person average signature expression
* `dot_within` = person-centered signature expression

```{r}
between = data %>%
  group_by(condition, wave, subjectID, algorithm) %>%
  summarize(dot_between = mean(dotProduct, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(dot_between = scale(dot_between, center = TRUE, scale = TRUE))

data_diss = data %>%
  group_by(wave, subjectID, algorithm) %>%
  mutate(dot_within = scale(dotProduct, center = TRUE, scale = TRUE)) %>%
  left_join(., between) %>%
  select(condition, subjectID, wave, trial, health, bid, liking_rating, algorithm, dotProduct, dot_within, dot_between)

data_diss_craving = data_diss %>%
  filter(algorithm == "craving")

data_diss_craving_koban = data_diss %>%
  filter(algorithm == "nsc_koban")

data_diss_regulation = data_diss %>%
  filter(algorithm == "craving_regulation")

data_diss_liking = data_all %>%
  group_by(wave, subjectID, algorithm) %>%
  mutate(dot_within = scale(dotProduct, center = TRUE, scale = TRUE)) %>%
  left_join(., between) %>%
  select(condition, subjectID, wave, trial, health, bid, liking_rating, algorithm, dotProduct, dot_within, dot_between)

data_diss_liking_craving = data_diss_liking %>%
  filter(algorithm == "craving")

data_diss_liking_craving_koban = data_diss_liking %>%
  filter(algorithm == "nsc_koban")

data_diss_liking_regulation = data_diss_liking %>%
  filter(algorithm == "craving_regulation")
```

# no brain
## bid ~ wave x health {.tabset}

> the intervention decreased bids for unhealthy foods and slightly increased bids for healthy foods

### tidytable
```{r}
mod_bid_health = lmer(bid ~ health * wave * condition + (1 | subjectID),
                  data = data_diss_craving,
                  control = lmerControl(optimizer = "bobyqa"))
table_model(mod_bid_health)
```

### plot
```{r}
ggeffects::ggpredict(mod_bid_health, terms = c("wave", "health", "condition")) %>%
  data.frame() %>%
  ggplot(aes(x, predicted, color = group, fill = group)) +
  geom_pointrange(aes(ymin = conf.low, ymax = conf.high)) +
  geom_line(aes(group = group)) +
  facet_grid(~facet) +
  scale_color_manual(name = "", values = food) + 
  scale_fill_manual(name = "", values = food) + 
  labs(x = "\nwave", y = "predicted bid value\n") + 
  dc_bw
```

### model summary
```{r}
summary(mod_bid_health)
```

# craving {.tabset}
## brain ~ health x wave {.tabset}

> craving signature expression for unhealthy foods decreased from wave 1 to 2; no change for healthy foods

### tidytable
```{r}
mod_health = lmer(dotProduct ~ health * wave * condition+ (1 | subjectID),
                  data = data_diss_craving,
                  control = lmerControl(optimizer = "bobyqa"))
table_model(mod_health)
```

### plot
```{r}
ggeffects::ggpredict(mod_health, terms = c("wave", "health", "condition")) %>%
  data.frame() %>%
  ggplot(aes(x, predicted, color = group, fill = group)) +
  geom_pointrange(aes(ymin = conf.low, ymax = conf.high)) +
  geom_line(aes(group = group)) +
  facet_grid(~facet) +
  scale_color_manual(name = "", values = food) + 
  scale_fill_manual(name = "", values = food) + 
  labs(x = "\nwave", y = "predicted pattern expression value\n") + 
  dc_bw
```

### model summary
```{r}
summary(mod_health)
```

## bid ~ brain x wave {.tabset}

> between-person expression: higher average expression is associated with lower bids

> within-person expression: higher trial-level expression is associated with higher bids

> intervention-related decreases in bid value aren weaker (i.e., more positive) for people who have higher expression average 

### tidy table
```{r}
mod_bid = lmer(bid ~ dot_between * wave * condition + dot_within * wave * condition + (1 | subjectID),
               data = data_diss_craving,
               control = lmerControl(optimizer = "bobyqa"))
table_model(mod_bid)
```

### plot {.tabset}
#### by wave
```{r}
vals = seq(-6, 6, .2)
ggeffects::ggpredict(mod_bid, terms = c("dot_between[vals]", "wave", "condition")) %>%
  data.frame() %>%
  mutate(type = "between-person") %>%
  bind_rows(ggeffects::ggpredict(mod_bid, terms = c("dot_within[vals]", "wave", "condition")) %>%
              data.frame() %>%
              mutate(type = "within-person")) %>%
  ggplot(aes(x, predicted, color = group, fill = group)) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high), alpha = .5, color = NA) +
  geom_line(aes(group = group)) +
  facet_grid(facet~type) +
  scale_color_manual(name = "wave", values = algorithm) + 
  scale_fill_manual(name = "wave", values = algorithm) + 
  labs(x = "\npattern expression value", y = "predicted bid value\n") + 
  dc_bw
```

#### by expression
```{r}
ggeffects::ggpredict(mod_bid, terms = c("wave", "dot_between [-1, 0, 1]", "condition")) %>%
  data.frame() %>%
  mutate(type = "between-person") %>%
  bind_rows(ggeffects::ggpredict(mod_bid, terms = c("wave", "dot_within [-1, 0, 1]", "condition")) %>%
              data.frame() %>%
              mutate(type = "within-person")) %>%
  ggplot(aes(x, predicted, color = group, fill = group)) +
  geom_pointrange(aes(ymin = conf.low, ymax = conf.high)) +
  geom_line(aes(group = group)) +
  facet_grid(facet~type) +
  scale_color_manual(name = "expression", values = algorithm) + 
  scale_fill_manual(name = "expression", values = algorithm) + 
  labs(x = "\nwave", y = "predicted bid value\n") + 
  dc_bw
```

### model summary
```{r}
summary(mod_bid)
```


## bid ~ brain x health x wave {.tabset}

> no 3-way interactions

### tidy table
```{r}
mod_bid_health = lmer(bid ~ dot_between*health*wave + dot_within*health*wave + (1 + health | subjectID),
                      data = data_diss_craving,
                      control = lmerControl(optimizer = "bobyqa"))
table_model(mod_bid_health)
```

### plot {.tabset}
#### by wave
```{r, fig.width=7, fig.height=7}
vals = seq(-6, 6, .2)
ggeffects::ggpredict(mod_bid_health, terms = c("dot_between[vals]", "wave", "health")) %>%
  data.frame() %>%
  mutate(type = "between-person") %>%
  bind_rows(ggeffects::ggpredict(mod_bid_health, terms = c("dot_within[vals]", "wave", "health")) %>%
              data.frame() %>%
              mutate(type = "within-person")) %>%
  ggplot(aes(x, predicted, color = group, fill = group)) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high), alpha = .5, color = NA) +
  geom_line(aes(group = group)) +
  facet_grid(type~facet) +
  scale_color_manual(name = "wave", values = algorithm) + 
  scale_fill_manual(name = "wave", values = algorithm) + 
  labs(x = "\npattern expression value", y = "predicted bid value\n") + 
  dc_bw
```

#### by expression
```{r, fig.width=7, fig.height=7}
ggeffects::ggpredict(mod_bid_health, terms = c("wave", "dot_between [-1, 0, 1]", "health")) %>%
  data.frame() %>%
  mutate(type = "between-person") %>%
  bind_rows(ggeffects::ggpredict(mod_bid_health, terms = c("wave", "dot_within [-1, 0, 1]", "health")) %>%
              data.frame() %>%
              mutate(type = "within-person")) %>%
  ggplot(aes(x, predicted, color = group, fill = group)) +
  geom_pointrange(aes(ymin = conf.low, ymax = conf.high)) +
  geom_line(aes(group = group)) +
  facet_grid(type~facet) +
  scale_color_manual(name = "expression", values = algorithm) + 
  scale_fill_manual(name = "expression", values = algorithm) + 
  labs(x = "\nwave", y = "predicted bid value\n") + 
  dc_bw
```

### model summary
```{r}
summary(mod_bid_health)
```

## brain ~ liking x health {.tabset}

> higher session 0 liking ratings are associated with stronger signature expression

> this relationship is stronger for unhealthy foods

### tidy table
```{r}
mod_liking = lmer(dotProduct ~ liking_rating * health + (1 | subjectID),
                  data = data_diss_liking_craving,
                  control = lmerControl(optimizer = "bobyqa"))
table_model(mod_liking)
```

### plot
```{r}
ggeffects::ggpredict(mod_liking, terms = c("liking_rating", "health")) %>%
  data.frame() %>%
  ggplot(aes(x, predicted, color = group, fill = group)) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high), alpha = .5, color = NA) +
  geom_line() +
  scale_color_manual(name = "", values = food) + 
  scale_fill_manual(name = "", values = food) + 
  labs(x = "\nliking rating (session 0)", y = "signature expression\n") + 
  dc_bw
```

### model summary
```{r}
summary(mod_liking)
```

# Koban craving {.tabset}
## brain ~ health x wave {.tabset}

> craving signature expression for unhealthy foods decreased from wave 1 to 2; no change for healthy foods

### tidytable
```{r}
mod_health = lmer(dotProduct ~ health * wave + (1 | subjectID),
                  data = data_diss_craving_koban,
                  control = lmerControl(optimizer = "bobyqa"))
table_model(mod_health)
```

### plot
```{r}
ggeffects::ggpredict(mod_health, terms = c("wave", "health")) %>%
  data.frame() %>%
  ggplot(aes(x, predicted, color = group, fill = group)) +
  geom_pointrange(aes(ymin = conf.low, ymax = conf.high)) +
  geom_line(aes(group = group)) +
  scale_color_manual(name = "", values = food) + 
  scale_fill_manual(name = "", values = food) + 
  labs(x = "\nwave", y = "predicted pattern expression value\n") + 
  dc_bw
```

### model summary
```{r}
summary(mod_health)
```

## bid ~ brain x wave {.tabset}

> between-person expression: higher average expression is associated with lower bids

> within-person expression: higher trial-level expression is associated with higher bids

> intervention-related decreases in bid value aren't moderated by signature expression

### tidy table
```{r}
mod_bid = lmer(bid ~ dot_between * wave + dot_within * wave + (1 | subjectID),
               data = data_diss_craving_koban,
               control = lmerControl(optimizer = "bobyqa"))
table_model(mod_bid)
```

### plot {.tabset}
#### by wave
```{r}
vals = seq(-6, 6, .2)
ggeffects::ggpredict(mod_bid, terms = c("dot_between[vals]", "wave")) %>%
  data.frame() %>%
  mutate(type = "between-person") %>%
  bind_rows(ggeffects::ggpredict(mod_bid, terms = c("dot_within[vals]", "wave")) %>%
              data.frame() %>%
              mutate(type = "within-person")) %>%
  ggplot(aes(x, predicted, color = group, fill = group)) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high), alpha = .5, color = NA) +
  geom_line(aes(group = group)) +
  facet_grid(~type) +
  scale_color_manual(name = "wave", values = algorithm) + 
  scale_fill_manual(name = "wave", values = algorithm) + 
  labs(x = "\npattern expression value", y = "predicted bid value\n") + 
  dc_bw
```

#### by expression
```{r}
ggeffects::ggpredict(mod_bid, terms = c("wave", "dot_between [-1, 0, 1]")) %>%
  data.frame() %>%
  mutate(type = "between-person") %>%
  bind_rows(ggeffects::ggpredict(mod_bid, terms = c("wave", "dot_within [-1, 0, 1]")) %>%
              data.frame() %>%
              mutate(type = "within-person")) %>%
  ggplot(aes(x, predicted, color = group, fill = group)) +
  geom_pointrange(aes(ymin = conf.low, ymax = conf.high)) +
  geom_line(aes(group = group)) +
  facet_grid(~type) +
  scale_color_manual(name = "expression", values = algorithm) + 
  scale_fill_manual(name = "expression", values = algorithm) + 
  labs(x = "\nwave", y = "predicted bid value\n") + 
  dc_bw
```


### model summary
```{r}
summary(mod_bid)
```


## bid ~ brain x health x wave {.tabset}

> relationship between within-person expression and bid values for unhealthy foods is slightly stronger at wave 2

### tidy table
```{r}
mod_bid_health = lmer(bid ~ dot_between*health*wave + dot_within*health*wave + (1 + health | subjectID),
                      data = data_diss_craving_koban,
                      control = lmerControl(optimizer = "bobyqa"))
table_model(mod_bid_health)
```

### plot {.tabset}
#### by wave
```{r, fig.width=7, fig.height=7}
vals = seq(-6, 6, .2)
ggeffects::ggpredict(mod_bid_health, terms = c("dot_between[vals]", "wave", "health")) %>%
  data.frame() %>%
  mutate(type = "between-person") %>%
  bind_rows(ggeffects::ggpredict(mod_bid_health, terms = c("dot_within[vals]", "wave", "health")) %>%
              data.frame() %>%
              mutate(type = "within-person")) %>%
  ggplot(aes(x, predicted, color = group, fill = group)) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high), alpha = .5, color = NA) +
  geom_line(aes(group = group)) +
  facet_grid(type~facet) +
  scale_color_manual(name = "wave", values = algorithm) + 
  scale_fill_manual(name = "wave", values = algorithm) + 
  labs(x = "\npattern expression value", y = "predicted bid value\n") + 
  dc_bw
```

#### by expression
```{r, fig.width=7, fig.height=7}
ggeffects::ggpredict(mod_bid_health, terms = c("wave", "dot_between [-1, 0, 1]", "health")) %>%
  data.frame() %>%
  mutate(type = "between-person") %>%
  bind_rows(ggeffects::ggpredict(mod_bid_health, terms = c("wave", "dot_within [-1, 0, 1]", "health")) %>%
              data.frame() %>%
              mutate(type = "within-person")) %>%
  ggplot(aes(x, predicted, color = group, fill = group)) +
  geom_pointrange(aes(ymin = conf.low, ymax = conf.high)) +
  geom_line(aes(group = group)) +
  facet_grid(type~facet) +
  scale_color_manual(name = "expression", values = algorithm) + 
  scale_fill_manual(name = "expression", values = algorithm) + 
  labs(x = "\nwave", y = "predicted bid value\n") + 
  dc_bw
```

### model summary
```{r}
summary(mod_bid_health)
```

## brain ~ liking x health {.tabset}

> higher session 0 liking ratings are associated with stronger signature expression

### tidy table
```{r}
mod_liking = lmer(dotProduct ~ liking_rating * health + (1 | subjectID),
                  data = data_diss_liking_craving_koban,
                  control = lmerControl(optimizer = "bobyqa"))
table_model(mod_liking)
```

### plot
```{r}
ggeffects::ggpredict(mod_liking, terms = c("liking_rating", "health")) %>%
  data.frame() %>%
  ggplot(aes(x, predicted, color = group, fill = group)) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high), alpha = .5, color = NA) +
  geom_line() +
  scale_color_manual(name = "", values = food) + 
  scale_fill_manual(name = "", values = food) + 
  labs(x = "\nliking rating (session 0)", y = "signature expression\n") + 
  dc_bw
```

### model summary
```{r}
summary(mod_liking)
```


# craving regulation {.tabset}
## brain ~ health x wave {.tabset}

> signature expression was stronger for unhealthy foods

> signature expression for unhealthy foods increase after the intervention

### tidytable
```{r}
mod_health = lmer(dotProduct ~ health * wave * condition + (1 + health | subjectID),
                  data = data_diss_regulation,
                  control = lmerControl(optimizer = "bobyqa"))
table_model(mod_health)
```

### plot
```{r}
ggeffects::ggpredict(mod_health, terms = c("wave", "health", "condition")) %>%
  data.frame() %>%
  ggplot(aes(x, predicted, color = group, fill = group)) +
  geom_pointrange(aes(ymin = conf.low, ymax = conf.high)) +
  geom_line(aes(group = group)) +
  facet_grid(~facet) +
  scale_color_manual(name = "", values = food) + 
  scale_fill_manual(name = "", values = food) + 
  labs(x = "\nwave", y = "predicted pattern expression value\n") + 
  dc_bw
```

### model summary
```{r}
summary(mod_health)
```

## bid ~ brain x wave {.tabset}

> between-person expression: higher average expression is associated with lower bids

> within-person expression: higher trial-level expression is associated with lower bids

> intervention-related decreases in bid value are stronger (i.e., more negative) on trials with higher than average expression

### tidy table
```{r}
mod_bid = lmer(bid ~ dot_between * wave * condition + dot_within * wave * condition + (1 + dot_within | subjectID),
               data = data_diss_regulation,
               control = lmerControl(optimizer = "bobyqa"))
table_model(mod_bid)
```

### plot {.tabset}
#### by wave
```{r}
vals = seq(-6, 6, .2)
ggeffects::ggpredict(mod_bid, terms = c("dot_between[vals]", "wave", "condition")) %>%
  data.frame() %>%
  mutate(type = "between-person") %>%
  bind_rows(ggeffects::ggpredict(mod_bid, terms = c("dot_within[vals]", "wave", "condition")) %>%
              data.frame() %>%
              mutate(type = "within-person")) %>%
  ggplot(aes(x, predicted, color = group, fill = group)) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high), alpha = .5, color = NA) +
  geom_line(aes(group = group)) +
  facet_grid(facet~type) +
  scale_color_manual(name = "wave", values = algorithm) + 
  scale_fill_manual(name = "wave", values = algorithm) + 
  labs(x = "\npattern expression value", y = "predicted bid value\n") + 
  dc_bw
```

#### by expression
```{r}
ggeffects::ggpredict(mod_bid, terms = c("wave", "dot_between [-1, 0, 1]")) %>%
  data.frame() %>%
  mutate(type = "between-person") %>%
  bind_rows(ggeffects::ggpredict(mod_bid, terms = c("wave", "dot_within [-1, 0, 1]")) %>%
              data.frame() %>%
              mutate(type = "within-person")) %>%
  ggplot(aes(x, predicted, color = group, fill = group)) +
  geom_pointrange(aes(ymin = conf.low, ymax = conf.high)) +
  geom_line(aes(group = group)) +
  facet_grid(~type) +
  scale_color_manual(name = "expression", values = algorithm) + 
  scale_fill_manual(name = "expression", values = algorithm) + 
  labs(x = "\nwave", y = "predicted bid value\n") + 
  dc_bw
```

### model summary
```{r}
summary(mod_bid)
```


## bid ~ brain x health x wave {.tabset}

> relationship between average (i.e., between-person) expression and bid values for unhealthy foods is slightly stronger (i.e., more negative) at wave 2

### tidy table
```{r}
mod_bid_health = lmer(bid ~ dot_between*health*wave*condition + dot_within*health*wave*condition + (1 + health | subjectID),
                      data = data_diss_regulation,
                      control = lmerControl(optimizer = "bobyqa"))
table_model(mod_bid_health)
```

### plot {.tabset}
#### by wave
```{r, fig.width=7, fig.height=7}
vals = seq(-6, 6, .2)
ggeffects::ggpredict(mod_bid_health, terms = c("dot_between[vals]", "wave", "health", "condition")) %>%
  data.frame() %>%
  mutate(type = "between-person") %>%
  bind_rows(ggeffects::ggpredict(mod_bid_health, terms = c("dot_within[vals]", "wave", "health", "condition")) %>%
              data.frame() %>%
              mutate(type = "within-person")) %>%
  ggplot(aes(x, predicted, color = group, fill = group)) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high), alpha = .5, color = NA) +
  geom_line(aes(group = group)) +
  facet_grid(panel ~ type + facet) +
  scale_color_manual(name = "wave", values = algorithm) + 
  scale_fill_manual(name = "wave", values = algorithm) + 
  labs(x = "\npattern expression value", y = "predicted bid value\n") + 
  dc_bw
```

#### by expression
```{r, fig.width=7, fig.height=7}
ggeffects::ggpredict(mod_bid_health, terms = c("wave", "dot_between [-1, 0, 1]", "health")) %>%
  data.frame() %>%
  mutate(type = "between-person") %>%
  bind_rows(ggeffects::ggpredict(mod_bid_health, terms = c("wave", "dot_within [-1, 0, 1]", "health")) %>%
              data.frame() %>%
              mutate(type = "within-person")) %>%
  ggplot(aes(x, predicted, color = group, fill = group)) +
  geom_pointrange(aes(ymin = conf.low, ymax = conf.high)) +
  geom_line(aes(group = group)) +
  facet_grid(type~facet) +
  scale_color_manual(name = "expression", values = algorithm) + 
  scale_fill_manual(name = "expression", values = algorithm) + 
  labs(x = "\nwave", y = "predicted bid value\n") + 
  dc_bw
```

### model summary
```{r}
summary(mod_bid_health)
```

## brain ~ liking x health {.tabset}

> higher session 0 liking ratings are associated with stronger signature expression for unhealthy foods

### tidy table
```{r}
mod_liking = lmer(dotProduct ~ liking_rating * health * condition + (1 | subjectID),
                  data = data_diss_liking_regulation,
                  control = lmerControl(optimizer = "bobyqa"))
table_model(mod_liking)
```

### plot
```{r}
ggeffects::ggpredict(mod_liking, terms = c("liking_rating", "health", "condition")) %>%
  data.frame() %>%
  ggplot(aes(x, predicted, color = group, fill = group)) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high), alpha = .5, color = NA) +
  geom_line() +
  facet_grid(~facet) +
  scale_color_manual(name = "", values = food) + 
  scale_fill_manual(name = "", values = food) + 
  labs(x = "\nliking rating (session 0)", y = "signature expression\n") + 
  dc_bw
```

### model summary
```{r}
summary(mod_liking)
```
