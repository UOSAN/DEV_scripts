---
title: "SST Paper generation"
author: "Ben Smith"
date: "2022-12-19"
output: 
  html_document: 
    toc: true
    toc_float: true
    code_folding: hide
    theme: spacelab
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,warning = FALSE)
```
This file just generates the stuf that goes into the final paper.
# Prep

```{r}
library(tidyverse)
Sys.setenv(R_CONFIG_ACTIVE = Sys.info()["nodename"])
print(Sys.info()["nodename"])

```

```{r}
dropbbox_dir <- config::get("dev_analysis_data_dir")

```



```{r}
time_points <- readr::read_csv(paste0(dropbbox_dir,"/SST_roi_by_time_point.csv"))
```


```{r}
roi_cols <- colnames(time_points)[grepl("harvardoxford",colnames(time_points))]
time_points$tr_roi_mean <- rowMeans(time_points[,roi_cols])
time_points<- 
  time_points %>% group_by(subid,wave) %>%
  mutate(run_mean_across_rois = mean(tr_roi_mean, na.rm = TRUE))

#now mean-center the ROIs
time_points_c<-time_points
for (roi_col in roi_cols){
  time_points_c[,roi_col]<-time_points_c[,roi_col]-time_points_c$run_mean_across_rois
}

#roi_cols <- colnames(time_points_c)[grepl("harvardoxford",colnames(time_points_c))]
#roi_cols_all <- colnames(time_points_c)#[grepl("((?<=harvardoxford-.{0,3}cortical_prob_)(.*))|(CueFollowing\\(CS\\>FS\\).*)",colnames(time_points_c),perl=TRUE)]
roi_detect_pattern<-"((?<=harvardoxford-.{0,3}cortical_prob_)(.*))|(CueFollowing\\(CS\\>FS\\).*)"

roi_cols_vec <- colnames(time_points_c) %>% stringr::str_detect(pattern = roi_detect_pattern)
new_roi_cols <- colnames(time_points_c) %>% stringr::str_extract_all(pattern = roi_detect_pattern) %>% unlist
unique(new_roi_cols)
colnames(time_points_c)[roi_cols_vec] <- new_roi_cols

```

We need to group by subject, wave, and trial, select just the FailedStop trials, and just the high trial numbers, then get the min and max accumbens activity. We could even do a long transform across the ROIs, then also group by ROI and get the min and max for ROIs

So let's first long transform the ROIs
```{r}

tpc_long<-time_points_c %>% pivot_longer(cols=all_of(new_roi_cols),names_to="ROI",values_to="value")

```


Now do the grouping and summarizing.

We define a peak period and trough period based on the previously observed shape of the accumbens response in the FS trial. This will put a peak around 2-6 seconds and a trough around 7-10 seconds. These values were chosen subjectively to try to encompass the peak and trough allowing for as much variability as possible without grabbing unrelated data from other time points. With a TR of 2.0 we should always have one or two images to grab from within these ranges, too.

```{r}

trial_summary_data <- tpc_long %>% 
  #filter(condition=="FailedStop") %>% 
  group_by(subid,wave,trial_n,ROI, condition) %>%
  summarise(
    peak=max(value[offset>=4.0 & offset <=11.0],na.rm = TRUE),
    trough = min(value[offset>=4.0 & offset <=11.0],na.rm = TRUE),
    peak_time = offset[offset>=4.0 & offset <=11.0][value[offset>=4.0 & offset <=11.0]==max(value[offset>=4.0 & offset <=11.0],na.rm = TRUE)],
    trough_time = offset[offset>=4.0 & offset <=11.0][value[offset>=4.0 & offset <=11.0]==min(value[offset>=4.0 & offset <=11.0],na.rm = TRUE)],
    med_post_trial = median(value[offset>=4.0 & offset <=10.0],na.rm = TRUE)
    
    
  )
  

trial_summary_data$response_amplitude <-trial_summary_data$peak-trial_summary_data$trough

ggplot(trial_summary_data %>% filter(condition=="FailedStop"),aes(response_amplitude,group=ROI,color=ROI))+geom_density(adjust=0.5)
```

OK. So now, let's try to merge in that with post-pre RTs. Where do we get those from?


## get the SST Post-pre data

```{r}
source(paste0(config::get("ben_dev_data_analysis"),"SST_processing.R"))

dropbox_file_dir = config::get("dev_analysis_data_dir")
sst_all_data_filepath <- paste0(dropbox_file_dir,"sst_behavioral_data_all.csv")

sst_all_data_raw <- readr::read_csv(sst_all_data_filepath)
sst_all_data<-clean_sst_data(sst_all_data_raw)
sst_all_data <- get_expected_tone_time(sst_all_data)

sst_all_data<-calculate_response_latency(sst_all_data)
sst_all_data<-calculate_rpe(sst_all_data)

sst_all_data<-get_more_sst_stats(sst_all_data)

#remove subjects with two many incorrect trials--theyre' probably not paying attention
hist(sst_all_data$stop_prop_correct)

sst_all_data <- sst_all_data %>% filter(stop_prop_correct>0.2 & stop_prop_correct<0.8)


# sst_all_data %>% select(
#   subid, waveid, runid, reaction_time_clean, SSD_recorded,condition, last_tone_delay, trials_since_last_SSD,last_correct_go)# %>%
#   #View()

```






```{r}
readr::write_csv(sst_all_data,file=paste0(dropbox_file_dir,"sst_behavioral_data_all_with_analysis.csv"))
```




```{r}
post_pre_rt_data <- sst_all_data%>% 
  filter(condition!="Cue") #%>%
  #select(trial_n,reaction_time,subid,waveid,runid,condition,post_pre_rt_change)
```


## Prepare neural data



```{r}
trial_summary_data$ROI_delateralized <-  trial_summary_data$ROI %>% str_replace_all("(Left|Right)\\s","")


trial_summary_data_delat <- trial_summary_data %>% 
  #filter(ROI %in% c("Left Accumbens","Right Accumbens")) %>% 
  group_by(subid,wave,trial_n, ROI_delateralized,condition) %>%
  summarize(peak=mean(peak),
            trough=mean(trough),
            peak_time=mean(peak_time),
            trough_time=mean(trough_time),
            response_amplitude=mean(response_amplitude),
            med_post_trial=mean(med_post_trial)
            )

```


## Merge the datasets



```{r}


trial_summary_data_delat_pp <- merge(trial_summary_data_delat,post_pre_rt_data,by.x = c("subid","wave","trial_n","condition"),by.y=c("subid","waveid","trial_n","condition"),all.x = TRUE)
  
trial_summary_data_delat_pp$trial_n_c<-128-trial_summary_data_delat_pp$trial_n

```

# Preparing regressors

```{r}

trial_neural_behav_data_not_na<-trial_summary_data_delat_pp[
  rowSums(is.na(trial_summary_data_delat_pp[,c("response_amplitude","post_pre_rt_change")]))==0 & #no NA values in correlation and
    is.finite(trial_summary_data_delat_pp$response_amplitude) & is.finite(trial_summary_data_delat_pp$post_pre_rt_change) #no infinite values
    ,]

trial_neural_behav_data_not_na$trial_n_c<-128-trial_neural_behav_data_not_na$trial_n


trial_neural_behav_roi <- trial_neural_behav_data_not_na %>% filter(ROI_delateralized=="CueFollowing(CS>FS)striatal_cluster_combined")

trial_neural_behav_roi$condition<-(
  factor(trial_neural_behav_roi$condition,
            levels=c("CorrectGo","CorrectStop","FailedGo","FailedStop"),
            ordered=FALSE))


trial_neural_behav_roi$trial_n_s<-scale(trial_neural_behav_roi$trial_n_c)
```


```{r}


trial_neural_behav_roi$peak_z<-scale(trial_neural_behav_roi$peak)
trial_neural_behav_roi$post_pre_rt_change_z<-scale(trial_neural_behav_roi$post_pre_rt_change)
trial_neural_behav_roi$P_stop_trial_change_z<-scale(trial_neural_behav_roi$P_stop_trial_change)
trial_neural_behav_roi$trial_n_z<-scale(trial_neural_behav_roi$trial_n)
trial_neural_behav_roi$med_post_trial_z<-scale(trial_neural_behav_roi$med_post_trial)

```

# Basic Striatal cluster mixed effects models


# All trial types, with P_Stop

I think if you're going to do P_stop

 - P_stop_trial seems mostly irrelevant and P_stop_trial_post is a more relevant measure; P_stop_trial_change is more relevant still.
 - measuring P_stop_trial rather than P_stop_trial_change doesn't make much sense, but
 - If you're only measuring FS, neither P_stop_trial_post nor P_stop_trial_change are necessarily going to measure what you think because the data is censored to just FS trials, which are _always_ going to move in a particular direction
 - so while measuring `P_stop_trial`, it's best to do a model with all kinds of trials

## stop conditions, with condition

```{r}
model_full_effects <- lme4::lmer(
   med_post_trial_z ~ trial_n_s+ condition + P_stop_trial_change+ post_pre_rt_change + (1 +post_pre_rt_change  + P_stop_trial_change  | subid),
  trial_neural_behav_roi %>% filter(trial_n>50 & condition %in% c("CorrectStop","FailedStop"))
  )
summary(model_full_effects)

model_no_rt<- lme4::lmer(
   med_post_trial_z ~ trial_n_s+ condition + P_stop_trial_change + (1 +post_pre_rt_change  + P_stop_trial_change  | subid),
  trial_neural_behav_roi %>% filter(trial_n>50 & condition %in% c("CorrectStop","FailedStop"))
  )

anova(model_full_effects,model_no_rt)
model_no_p_stop<- lme4::lmer(
   med_post_trial_z ~ trial_n_s+ condition + post_pre_rt_change + (1 +post_pre_rt_change  + P_stop_trial_change  | subid),
  trial_neural_behav_roi %>% filter(trial_n>50 & condition %in% c("CorrectStop","FailedStop"))
  )

anova(model_full_effects,model_no_p_stop)

```


## z-scored

### with condition interactions
```{r}
model_P_stop_trial_w_change <- lme4::lmer(
   med_post_trial_z ~ trial_n_z +condition + post_pre_rt_change_z + P_stop_trial_change_z + P_stop_trial_change_z:(condition=="FailedStop") +(1+ post_pre_rt_change_z + P_stop_trial_change_z + P_stop_trial_change_z:(condition=="FailedStop") | subid),
  trial_neural_behav_roi %>% filter(trial_n>50 & condition %in% c("CorrectStop","FailedStop"))
  )
summary(model_P_stop_trial_w_change)

#ignoring post_pre_rt_change_z
model_P_stop_trial_w_change_no_rt <- lme4::lmer(
   med_post_trial_z ~ trial_n_z +condition +  P_stop_trial_change_z + P_stop_trial_change_z:(condition=="FailedStop") +(1+ post_pre_rt_change_z + P_stop_trial_change_z + P_stop_trial_change_z:(condition=="FailedStop") | subid),
  trial_neural_behav_roi %>% filter(trial_n>50 & condition %in% c("CorrectStop","FailedStop"))
  )
summary(model_P_stop_trial_w_change_no_rt)

anova(model_P_stop_trial_w_change,model_P_stop_trial_w_change_no_rt)

#ignoring P_stop_trial_change_z
model_P_stop_trial_w_change_no_p_stop_d <- lme4::lmer(
   med_post_trial_z ~ trial_n_z +condition +  post_pre_rt_change_z +(1+ post_pre_rt_change_z + P_stop_trial_change_z + P_stop_trial_change_z:(condition=="FailedStop") | subid),
  trial_neural_behav_roi %>% filter(trial_n>50 & condition %in% c("CorrectStop","FailedStop"))
  )
summary(model_P_stop_trial_w_change_no_p_stop_d)


anova(model_P_stop_trial_w_change, model_P_stop_trial_w_change_no_p_stop_d)

```

# Looking at CS and FS trials separately.

A valid question is: does this particular signal track pre-post RT change, just considering CS and FS individually?

This builds evidence that this activity both tracks an RPE signal, and distinct from the peak at t_0_5, which seems to only track pre-post RT change when it comes to FailedStop trials.

# Just CS Trials

```{r}

model_P_stop_trial_w_change <- lme4::lmer(
   med_post_trial_z ~ trial_n_z + post_pre_rt_change_z + P_stop_trial_change_z +(1+ post_pre_rt_change_z + P_stop_trial_change_z  | subid),
  trial_neural_behav_roi %>% filter(trial_n>50 & condition %in% c("CorrectStop"))
  )


#ignoring post_pre_rt_change_z
model_P_stop_trial_w_change_no_rt <- lme4::lmer(
   med_post_trial_z ~ trial_n_z  + P_stop_trial_change_z +(1+ post_pre_rt_change_z + P_stop_trial_change_z  | subid),
  trial_neural_behav_roi %>% filter(trial_n>50 & condition %in% c("CorrectStop"))
  )

anova(model_P_stop_trial_w_change,model_P_stop_trial_w_change_no_rt)

#ignoring P_stop_trial_change_z
model_P_stop_trial_w_change_no_p_stop_d <- lme4::lmer(
   med_post_trial_z ~ trial_n_z +  post_pre_rt_change_z +(1+ post_pre_rt_change_z + P_stop_trial_change_z | subid),
  trial_neural_behav_roi %>% filter(trial_n>50 & condition %in% c("CorrectStop"))
  )


anova(model_P_stop_trial_w_change, model_P_stop_trial_w_change_no_p_stop_d)

```




# Just FS Trials

## median

```{r}

model_P_stop_trial_w_change <- lme4::lmer(
   med_post_trial_z ~ trial_n_z + post_pre_rt_change_z + P_stop_trial_change_z +(1+ post_pre_rt_change_z + P_stop_trial_change_z  | subid),
  trial_neural_behav_roi %>% filter(trial_n>50 & condition %in% c("FailedStop"))
  )
summary(model_P_stop_trial_w_change)

#ignoring post_pre_rt_change_z
model_P_stop_trial_w_change_no_rt <- lme4::lmer(
   med_post_trial_z ~ trial_n_z  + P_stop_trial_change_z +(1+ post_pre_rt_change_z + P_stop_trial_change_z  | subid),
  trial_neural_behav_roi %>% filter(trial_n>50 & condition %in% c("FailedStop"))
  )
#summary(model_P_stop_trial_w_change_no_rt)

anova(model_P_stop_trial_w_change,model_P_stop_trial_w_change_no_rt)

#ignoring P_stop_trial_change_z
model_P_stop_trial_w_change_no_p_stop_d <- lme4::lmer(
   med_post_trial_z ~ trial_n_z +  post_pre_rt_change_z +(1+ post_pre_rt_change_z + P_stop_trial_change_z | subid),
  trial_neural_behav_roi %>% filter(trial_n>50 & condition %in% c("FailedStop"))
  )
#summary(model_P_stop_trial_w_change_no_p_stop_d)


anova(model_P_stop_trial_w_change, model_P_stop_trial_w_change_no_p_stop_d)

```

## median, all trials


```{r}

model_P_stop_trial_w_change <- lme4::lmer(
   med_post_trial_z ~ trial_n_z + post_pre_rt_change_z + P_stop_trial_change_z +(1+ post_pre_rt_change_z + P_stop_trial_change_z  | subid),
  trial_neural_behav_roi %>% filter(condition %in% c("FailedStop"))
  )
summary(model_P_stop_trial_w_change)

#ignoring post_pre_rt_change_z
model_P_stop_trial_w_change_no_rt <- lme4::lmer(
   med_post_trial_z ~ trial_n_z  + P_stop_trial_change_z +(1+ post_pre_rt_change_z + P_stop_trial_change_z  | subid),
  trial_neural_behav_roi %>% filter(condition %in% c("FailedStop"))
  )
summary(model_P_stop_trial_w_change_no_rt)

anova(model_P_stop_trial_w_change,model_P_stop_trial_w_change_no_rt)

#ignoring P_stop_trial_change_z
model_P_stop_trial_w_change_no_p_stop_d <- lme4::lmer(
   med_post_trial_z ~ trial_n_z +  post_pre_rt_change_z +(1+ post_pre_rt_change_z + P_stop_trial_change_z | subid),
  trial_neural_behav_roi %>% filter(condition %in% c("FailedStop"))
  )
summary(model_P_stop_trial_w_change_no_p_stop_d)


anova(model_P_stop_trial_w_change, model_P_stop_trial_w_change_no_p_stop_d)

```

#### distribution thereof

```{r}
# plot a ggplot2 point graph of trial_neural_behav_roi filtered by FailedStop, plotting med_post_trial_z against post_pre_rt_change_z
# coloring points by whether trial_n is <50 or not

ggplot(data = trial_neural_behav_roi %>%
          filter(condition=="FailedStop"),
        aes(x = med_post_trial_z,
            y = post_pre_rt_change_z,
            color = trial_n < 50)) +
   geom_point(alpha=0.1)
```





## trough
For comparison--if we use trough (it should generally be a trough for FS) do we still see the effect?



```{r}


model_P_stop_trial_w_change <- lme4::lmer(
   trough ~ trial_n_z + post_pre_rt_change_z + P_stop_trial_change_z +(1+ post_pre_rt_change_z + P_stop_trial_change_z  | subid),
  trial_neural_behav_roi %>% filter(trial_n>50 & condition %in% c("FailedStop"))
  )
summary(model_P_stop_trial_w_change)

#ignoring post_pre_rt_change_z
model_P_stop_trial_w_change_no_rt <- lme4::lmer(
   trough ~ trial_n_z  + P_stop_trial_change_z +(1+ post_pre_rt_change_z + P_stop_trial_change_z  | subid),
  trial_neural_behav_roi %>% filter(trial_n>50 & condition %in% c("FailedStop"))
  )
summary(model_P_stop_trial_w_change_no_rt)

anova(model_P_stop_trial_w_change,model_P_stop_trial_w_change_no_rt)

#ignoring P_stop_trial_change_z
model_P_stop_trial_w_change_no_p_stop_d <- lme4::lmer(
   trough ~ trial_n_z +  post_pre_rt_change_z +(1+ post_pre_rt_change_z + P_stop_trial_change_z | subid),
  trial_neural_behav_roi %>% filter(trial_n>50 & condition %in% c("FailedStop"))
  )
summary(model_P_stop_trial_w_change_no_p_stop_d)


anova(model_P_stop_trial_w_change, model_P_stop_trial_w_change_no_p_stop_d)

```




# Between-subjects measures


## Between subjects

```{r}

trial_neural_behav_data_not_na$trial_n_n<-scale(trial_neural_behav_data_not_na$trial_n_c)


FS_neural_behav_data_not_na<-trial_neural_behav_data_not_na[trial_neural_behav_data_not_na$condition=="FailedStop",]
```


```{r}
activity_by_subj <- trial_neural_behav_data_not_na %>% filter(condition %in% c("CorrectStop","FailedStop")) %>%
 group_by(subid,wave,runid,ROI_delateralized,condition) %>%
  summarize(mean_med_post_stop_signal=mean(med_post_trial),
            mean_post_pre_rt = mean(post_pre_rt_change),
            mean_peak = mean(peak),
            mean_trough = mean(trough)
            ) %>%
  tidyr::pivot_wider(names_from="condition", values_from=c("mean_med_post_stop_signal","mean_post_pre_rt", "mean_peak","mean_trough")) %>%
  mutate(
    "post_stop_signal_CSMinusFS"=mean_med_post_stop_signal_CorrectStop-mean_med_post_stop_signal_FailedStop,
    "post_pre_rt_CSMinusFS"=mean_post_pre_rt_CorrectStop-mean_post_pre_rt_FailedStop,
    "post_stop_signal_CSPeakMinusFSTrough" = mean_peak_CorrectStop-mean_trough_FailedStop
         )

# get subject-level FS>CS contrast for the relevant region
```


```{r}
behav_by_subj <- sst_all_data %>% group_by(subid, waveid, runid) %>%
  summarize(mean_ssrt_0=mean(mean_ssrt_0,na.rm=TRUE),
            stop_prop_correct = mean(stop_prop_correct,na.rm=TRUE)
            )
activity_by_subj_w1 <- activity_by_subj %>% filter(wave==1 & runid==1)

by_subj <- merge(behav_by_subj,activity_by_subj,
                 by.x=c("subid","waveid","runid"),by.y=c("subid","wave","runid"))
by_subj_striatum<-by_subj %>% filter(ROI_delateralized=="CueFollowing(CS>FS)striatal_cluster_combined")

by_subj_striatum_w1 <- by_subj_striatum%>% filter(waveid==1 & runid==1)

cor.test(by_subj_striatum_w1$mean_ssrt_0,by_subj_striatum_w1$post_stop_signal_CSMinusFS) # a 

by_subj_striatum_no_outliers <- by_subj_striatum_w1 %>% filter(mean_ssrt_0>-0.2)

#does the size of the gap between signal for a subject indicate how much they're able to adjust in response to stimuli?
cor.test(by_subj_striatum_no_outliers$post_pre_rt_CSMinusFS,by_subj_striatum_no_outliers$post_stop_signal_CSMinusFS)
#no.

#but does the size of that gap indicate their SSRT?
cor.test(by_subj_striatum_no_outliers$mean_ssrt_0,by_subj_striatum_no_outliers$post_stop_signal_CSMinusFS) # a good start
#no, not remotely, once we remove the subjects who don't seem to be paying attention

plot(by_subj_striatum$mean_ssrt_0,by_subj_striatum$post_stop_signal_CSMinusFS)
plot(by_subj_striatum$mean_ssrt_0,by_subj_striatum$post_stop_signal_CSMinusFS)

```


What if we did a more extreme outlier cut--only subjects between 0.4 and 0.6 proportion correct? The vast majority are in that range; subjects outside that range haven't been very precisely titrated.


```{r}
by_subj_striatum_no_outliers <- by_subj_striatum_w1 %>% filter(mean_ssrt_0>-0.2 & stop_prop_correct>=0.4 & stop_prop_correct<=0.6)

#does the size of the gap between signal for a subject indicate how much they're able to adjust in response to stimuli?
cor.test(by_subj_striatum_no_outliers$post_pre_rt_CSMinusFS,by_subj_striatum_no_outliers$post_stop_signal_CSMinusFS)
#SUBJECTS who had stronger signals had stronger RT adjustments. This is useful. Sort of.

#but does the size of that gap indicate their SSRT?
cor.test(by_subj_striatum_no_outliers$mean_ssrt_0,by_subj_striatum_no_outliers$post_stop_signal_CSMinusFS) # a good start
#no

```

## Peak and trough effects

```{r}

by_subj_striatum_w1 <- by_subj_striatum

sst_subject_means <- by_subj_striatum %>% group_by(subid) %>% summarize(subj_mean_ssrt_0=mean(mean_ssrt_0))
by_subj_striatum_w1 <- merge(by_subj_striatum_w1,sst_subject_means)

cor.test(by_subj_striatum_w1$mean_ssrt_0,by_subj_striatum_w1$post_stop_signal_CSPeakMinusFSTrough)
cor.test(by_subj_striatum_w1$subj_mean_ssrt_0,by_subj_striatum_w1$post_stop_signal_CSPeakMinusFSTrough)


by_subj_striatum_no_outliers <- by_subj_striatum_w1 %>% filter(mean_ssrt_0>-0.2 & waveid==1)

#does the size of the gap between signal for a subject indicate how much they're able to adjust in response to stimuli?
cor.test(by_subj_striatum_no_outliers$post_pre_rt_CSMinusFS,by_subj_striatum_no_outliers$post_stop_signal_CSPeakMinusFSTrough)
cor.test(by_subj_striatum_no_outliers$post_pre_rt_CSMinusFS,by_subj_striatum_no_outliers$post_stop_signal_CSPeakMinusFSTrough,method = "spearman")
#no.

#but does the size of that gap indicate their SSRT?
cor.test(by_subj_striatum_no_outliers$mean_ssrt_0,by_subj_striatum_no_outliers$post_stop_signal_CSPeakMinusFSTrough) # a good
cor.test(by_subj_striatum_no_outliers$mean_ssrt_0,by_subj_striatum_no_outliers$post_stop_signal_CSPeakMinusFSTrough,method = "spearman")

cor.test(by_subj_striatum_no_outliers$subj_mean_ssrt_0,by_subj_striatum_no_outliers$post_stop_signal_CSPeakMinusFSTrough) # a good
cor.test(by_subj_striatum_no_outliers$subj_mean_ssrt_0,by_subj_striatum_no_outliers$post_stop_signal_CSPeakMinusFSTrough,method = "spearman")

#no, not remotely, once we remove the subjects who don't seem to be paying attention

plot(by_subj_striatum$mean_ssrt_0,by_subj_striatum$post_stop_signal_CSPeakMinusFSTrough)
plot(by_subj_striatum$mean_ssrt_0,by_subj_striatum$post_stop_signal_CSPeakMinusFSTrough)

```



```{r}

by_subj_striatum_no_outliers <- by_subj_striatum_w1 %>% filter(mean_ssrt_0>-0.2 & stop_prop_correct>=0.4 & stop_prop_correct<=0.6 & waveid==1)

#does the size of the gap between signal for a subject indicate how much they're able to adjust in response to stimuli?
cor.test(by_subj_striatum_no_outliers$post_pre_rt_CSMinusFS,by_subj_striatum_no_outliers$post_stop_signal_CSPeakMinusFSTrough)
#no.

#but does the size of that gap indicate their SSRT?
cor.test(by_subj_striatum_no_outliers$mean_ssrt_0,by_subj_striatum_no_outliers$post_stop_signal_CSPeakMinusFSTrough) # a good start
#no, not remotely, once we remove the subjects who don't seem to be paying attention

```
## RTFS

```{r}



by_subj_striatum_no_outliers <- by_subj_striatum %>% filter(mean_ssrt_0>-0.2 & waveid==1)


data_by_ppt<-readr::read_csv(paste0(dropbox_file_dir,"data_by_ppt.csv"))

data_by_ppt_w_neural <- merge(data_by_ppt, by_subj_striatum_no_outliers)

```



# Graph it

```{r}
# selected_points <- trial_neural_behav_roi %>% filter(trial_n>50 & condition %in% c("CorrectStop","FailedStop"))
# ggplot(
#   trial_neural_behav_roi %>% filter(trial_n>50 & condition %in% c("CorrectStop","FailedStop")),
#        aes(x=med_post_trial_z,y=post_pre_rt_change_z,color=condition)
#        )+geom_point(alpha=0.05)
# 
# cor.test(selected_points$med_post_trial_z,selected_points$post_pre_rt_change_z)
```

```{r}


# cor.test(by_subj_striatum_no_outliers$post_pre_rt_CSMinusFS,by_subj_striatum_no_outliers$rtfs,method = "spearman")
```

